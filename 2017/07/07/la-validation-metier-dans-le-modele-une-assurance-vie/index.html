<!DOCTYPE html>
<html>


<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>La validation métier dans le modèle, une assurance vie &#8211; Objectivement objectif.</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Apprendre à valider autrement ses données.&#10; &#35;php &#35;domain model &#35;symfony &#35;validation &#35;ddd">
    <meta name="author" content="Quentin Pautrat">
    <meta name="keywords" content="php, domain model, symfony, validation, ddd">
    <link rel="canonical" href="http://qpautrat.github.io/2017/07/07/la-validation-metier-dans-le-modele-une-assurance-vie/">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css" type="text/css">

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    
        <meta property="og:locale" content="fr_FR">
    
    <meta property="og:type" content="article">
    <meta property="og:title" content="La validation métier dans le modèle, une assurance vie">
    <meta property="og:description" content="Apprendre à valider autrement ses données.&#10; &#35;php &#35;domain model &#35;symfony &#35;validation &#35;ddd">
    <meta property="og:url" content="http://qpautrat.github.io/2017/07/07/la-validation-metier-dans-le-modele-une-assurance-vie/">
    <meta property="og:site_name" content="Objectivement objectif.">
    
      <meta property="og:image" content="http://qpautrat.github.io/assets/keep-calm-and-trust-your-model.jpg">
    

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@qpautrat" />
    <meta name="twitter:title" content="La validation métier dans le modèle, une assurance vie" />
    <meta name="twitter:description" content="Apprendre à valider autrement ses données.&#10; &#35;php &#35;domain model &#35;symfony &#35;validation &#35;ddd" />
    
      <meta name="twitter:image" content="http://qpautrat.github.io/assets/keep-calm-and-trust-your-model.jpg" />
    

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32">
</head>

<body class="">
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://qpautrat.github.io" class="site-title">Objectivement objectif.</a>
      <nav class="site-nav right">
        
      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="left">
    
      <a class="fa fa-github" href="https://github.com/qpautrat"></a>
    
    
    <a class="fa fa-rss" href="/feed.xml"></a>
    
      <a class="fa fa-twitter" href="https://twitter.com/qpautrat"></a>
    
    
    
    
      <a class="fa fa-linkedin" href="https://www.linkedin.com/in/qpautrat"></a>
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>La validation métier dans le modèle, une assurance vie</h1>
  <span class="post-meta">Jul 7, 2017</span><br>
  
  <span class="post-meta small">5 minute read</span>
  
    <span class="post-meta small">#php #domain model #symfony #validation #ddd</span><br>
  
</div>

<article class="post-content">
  <p>Aujourd’hui j’aimerais parler de validation.
Si j’ai envie d’aborder le sujet c’est parce que bien souvent les développeurs ne connaissent qu’une seule façon de faire sans trop se demander si on peut procéder autrement.</p>

<h3 id="la-documentation-un-effet-perfide">La documentation, un effet perfide</h3>

<p><em>Symfony</em>, par exemple,  mais ce n’est pas le seul, est un framework web très bien documenté.
La plupart du temps il suffit de copier-coller un bout de code de ce qui nous intéresse et… <em>voilà</em> !
Cette documentation vous explique <strong>comment fonctionne</strong> la librairie, pas de quelle façon elle <strong>s’intègre</strong> le mieux à votre <strong>conception logicielle</strong>.</p>

<h3 id="ce-que-je-vois-trop-souvent">Ce que je vois trop souvent</h3>

<p>Prenons l’exemple d’une machine à café. Il est possible de configurer le nombre de morceaux de sucre désiré.
Une contrainte métier nous dit que ce nombre ne peut-être qu’un entier supérieur ou égal à 0.</p>

<p><em>Symfony</em> est livré par défaut avec le <a href="https://github.com/symfony/validator">composant <em>validator</em></a>.
Il est facile à utiliser, met à disposition un bon nombre de règles par défaut et sa documentation est plutôt bien foutue.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="c1">// CoffeeMachine.php</span>

<span class="kn">use</span> <span class="nc">Symfony\Component\Validator\Constraints</span> <span class="k">as</span> <span class="nc">Assert</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">CoffeeMachine</span>
<span class="p">{</span>
    <span class="cd">/**
     * @Assert\Type("integer")
     * @Assert\GreaterThanOrEqual(0)
     */</span>
    <span class="k">private</span> <span class="nv">$numberOfSugarLump</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">addSugar</span><span class="p">(</span><span class="nv">$numberOfLump</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">numberOfSugarLump</span> <span class="o">=</span> <span class="nv">$numberOfLump</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Controller.php</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">addSugarAction</span><span class="p">(</span><span class="kt">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="kt">CoffeeMachine</span> <span class="nv">$coffeeMachine</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$coffeeMachine</span><span class="o">-&gt;</span><span class="nf">addSugar</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'numberOfSugarLump'</span><span class="p">));</span>

    <span class="nv">$validator</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'validator'</span><span class="p">);</span>
    <span class="nv">$errors</span> <span class="o">=</span> <span class="nv">$validator</span><span class="o">-&gt;</span><span class="nf">validate</span><span class="p">(</span><span class="nv">$coffeeMachine</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">render</span><span class="p">(</span><span class="s1">'coffeeMachine/error.html.twig'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">'errors'</span> <span class="o">=&gt;</span> <span class="nv">$errors</span><span class="p">,</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'doctrine.orm.entity_manager'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">flush</span><span class="p">();</span>

    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">render</span><span class="p">(</span><span class="s1">'coffeeMachine/success.html.twig'</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>À première vue, on pourrait se dire que c’est simple, que cela fonctionne très bien et qu’il n’y a aucune raison de faire autrement.</p>

<h3 id="oui-mais">Oui mais…</h3>

<p>Le problème est l’<strong>état</strong> dans lequel se trouve notre modèle <code class="language-plaintext highlighter-rouge">CoffeeMachine</code>. Si le nombre de morceaux, que l’on récupère depuis l’objet <code class="language-plaintext highlighter-rouge">Request</code>, est négatif notre machine est dans un état qu’on appelle <strong>invalide</strong>, même pour un court laps de temps.</p>

<blockquote>
  <p>Oui c’est normal et c’est pour ça qu’on a notre couche de validation, pour s’assurer qu’on ne persiste pas de mauvaises données.</p>
</blockquote>

<p>me direz-vous.</p>

<p>Que se passe t’il si vous ajoutez des morceaux <strong>après</strong> votre couche de validation ?</p>

<blockquote>
  <p>Ça n’arrivera jamais, je sais ce que je fais.</p>
</blockquote>

<p>Certes, mais si je vous dis que votre équipe technique va être multipliée par 5 durant les prochains mois, que votre <em>code base</em> va grossir exponentiellement et donc sa complexité par extension. Si je vous dis que vous allez devoir faire de l’asynchrone, multiplier les sources de données, etc… Même un système de <em>code review</em> efficace ne sera pas suffisant pour s’assurer de la cohérence de vos données. Et pour peu que vous vous absentiez un temps, c’est <em>la fin des haricots</em>.</p>

<h3 id="le-métier-dans-le-métier-">Le métier dans le métier !</h3>

<p class="center"><img src="/assets/keep-calm-and-trust-your-model.jpg" alt="Keep calm and trust your model" /></p>

<p>Selon moi, (<a href="http://codebetter.com/gregyoung/2009/05/22/always-valid/">et bien d’autres</a>) vos modèles devraient <strong>toujours</strong> être dans un état valide.
C’est une chose de moins à se soucier.</p>

<p>Quand on y pense, c’est une contrainte business. Elle a toute sa place dans notre <strong>domaine</strong> non ?! Pourquoi l’exclure et la déléguer à notre <a href="http://dddsample.sourceforge.net/architecture.html">couche application</a> ?</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="c1">// CoffeeMachine.php</span>

<span class="c1">// Librarie de validation par Benjamin Eberlei.</span>
<span class="kn">use</span> <span class="nc">Assert\Assertion</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">CoffeeMachine</span>
<span class="p">{</span>
    <span class="cd">/**
     * @Assert\Type("integer")
     * @Assert\GreaterThanOrEqual(0)
     */</span>
    <span class="k">private</span> <span class="nv">$numberOfSugarLump</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">addSugar</span><span class="p">(</span><span class="nv">$numberOfLump</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nc">Assertion</span><span class="o">::</span><span class="nf">integer</span><span class="p">(</span><span class="nv">$numberOfLump</span><span class="p">);</span>
        <span class="nc">Assertion</span><span class="o">::</span><span class="nf">greaterOrEqualThan</span><span class="p">(</span><span class="nv">$numberOfLump</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="nv">$numberOfSugarLump</span> <span class="o">=</span> <span class="nv">$numberOfLump</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<blockquote>
  <p>Ok mais il y a maintenant deux étapes de validations qui font exactement la même chose, c’est redondant !</p>
</blockquote>

<p>Oui et non. Si votre contexte vous force à informer le client des erreurs qu’il aurait pu faire alors vous pouvez considérer votre validation
comme une couche de présentation, rien de plus. C’est juste une couche qui vous permet de formater simplement vos erreurs dans votre <code class="language-plaintext highlighter-rouge">Response</code>.</p>

<p>Dans certains contextes, cette couche de présentation sera inutile et vous pourrez même la supprimer purement et simplement (mais ça j’en parlerai dans un autre billet).</p>

<h3 id="testabilité">Testabilité</h3>

<p>Le plus beau dans tout ça c’est que pouvez maintenant tester unitairement votre validation d’un point de vue métier.
Plus besoin de charger un système de test avec tout un tas de détails d’infrastructure (client HTTP, base de données, …).</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="cd">/**
 * @test
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">it_should_add_a_natural_integer_or_zero_number_of_sugar_lump</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$coffeeMachine</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CoffeeMachine</span><span class="p">();</span>
    <span class="nv">$coffeeMachine</span><span class="o">-&gt;</span><span class="nf">addSugar</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">expectException</span><span class="p">(</span><span class="err">\</span><span class="nc">InvalidArgumentException</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<h3 id="conclusion">Conclusion</h3>

<p>Mettre de la validation dans le modèle présente de vrais avantages. Cependant ce n’est peut-être pas nécessaire d’en faire aveuglément partout.
Si vous travaillez sur un projet très fortement orienté CRUD, sans beaucoup de logique métier, déléguer la validation à un composant tierce fera l’affaire.
Soyez simplement averti que la complexité d’un projet augmente rapidement et qu’il n’appartient qu’à vous de détecter le moment où les choses se corsent.</p>

</article>


  <div class="share-page">
  Objectivement, tu <u>dois</u> partager

  <div class="share-links">
    
      <a class = "fa fa-facebook" href="https://facebook.com/sharer.php?u=http://qpautrat.github.io/2017/07/07/la-validation-metier-dans-le-modele-une-assurance-vie/" rel="nofollow" target="_blank" title="Share on Facebook"></a>
    

    
      

      <a class="fa fa-twitter" href="https://twitter.com/intent/tweet?text=La validation métier dans le modèle, une assurance vie via @pautrat%0A %23php %23domain model %23symfony %23validation %23ddd%0A&url=http://qpautrat.github.io/2017/07/07/la-validation-metier-dans-le-modele-une-assurance-vie/" rel="nofollow" target="_blank" title="Share on Twitter"></a>
    

    

    
      <a class="fa fa-linkedin" href="http://www.linkedin.com/shareArticle?url=http://qpautrat.github.io/2017/07/07/la-validation-metier-dans-le-modele-une-assurance-vie/&title=La validation métier dans le modèle, une assurance vie" rel="nofollow" target="_blank" title="Share on LinkedIn"></a>
    

    

    

    

    
  </div>
</div>









      </div>
    </div>
  </div>

  <footer class="footer">
  <div class="p2 wrap">
    <div class="measure mt1 center">
      <small>
        Crafted with &lt;3 by <a href="http://johnotander.com">John Otander</a> (<a href="https://twitter.com/4lpine">@4lpine</a>).<br>
        &lt;/&gt; available on <a href="https://github.com/johnotander/pixyll">Github</a>.
      </small>
    </div>
  </div>
</footer>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-49889834-2', 'auto');
ga('send', 'pageview');

</script>


</body>
</html>
